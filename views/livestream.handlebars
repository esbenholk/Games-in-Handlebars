<!DOCTYPE html>
<html lang="en">
	<head>
		<title>HOUSE OF KILLING</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link type="text/css" rel="stylesheet" href="livestreamstyle.css">

		<style>

		</style>

	</head>
	<body>
		<div class="page">
			<div id="logoes">
				<img class="logo" id="four42020" src="teletubby/42020.png"/>
				<div id="cluster-felt">
				<img class="logo" id="clusterdcuklogo" src="teletubby/ClusterduckLogo.png"/>
				<img class="logo" id="feltzine" src="teletubby/feltzine.png"/>
				</div>
			</div>
			<div id="joint">
				<div class="jointparts suncontainer" >
			     <img class="jointfront jointparts sunpart" src="teletubby/top.png" alt="hiiiiiigh" />
				 <!-- <img id="sun" class=" jointfront jointparts sunpart" src="teletubby/sun.png" alt="hiiiiiigh" /> -->
				 </div>
		        <div id="container" class="jointparts"></div>
		        <img id="jointback" class="jointparts" src="teletubby/bottom.png" alt="hi" />
			</div>
		</div>
		<div id="chatcontainer">
			<button id="chattoggle">CHAT</button>
	        <div id="chat" class="invisible">
	            	<ul id="messages"></ul>
	                <form action="" id="chatform" >
	                  <input id="m" autocomplete="off" /><button id="chatbutton">Send</button>
	                </form>
	        </div>
		</div>

		<div id="tickercontainer">
	        <div id="ticker" class="ticker">
		        <div class="credits">
		            <a> credits credtis credits credits </a>
					<a> credits credtis credits credits </a>
					<a> credits credtis credits credits </a>
					<a> credits credtis credits credits </a>
					<a> credits credtis credits credits </a>
					<a> credits credtis credits credits </a>
					<a> credits credtis credits credits </a>
					<a> credits credtis credits credits </a>
					<a> credits credtis credits credits </a>
					<a> credits credtis credits credits </a>
					<a> credits credtis credits credits </a>
					<a> credits credtis credits credits </a>
					<a> credits credtis credits credits </a>
					<a> credits credtis credits credits </a>
					<a> credits credtis credits credits </a>

		        </div>
		     </div>

		 </div>

		<div id="blocker">
			<div id="instructions">
				<div id="inputform">
			        <h1 id="space">
			          name your space
			          <input
			            type="text"
			            id="room-id"
			            value="420"
			            autocorrect="off"
			            autocapitalize="off"
			            size="20"
			          />
			        </h1>
			        <div class="buttons">
			        <button id="btn-open-room">Open Room</button>
			        <button id="btn-join-room">Join Room</button>
			        </div>
		        </div>
				<img id="coverpic" src="Join-the-Joint.png"/>
			</div>
		</div>



<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
<script src="https://rtcmulticonnection.herokuapp.com/dist/RTCMultiConnection.min.js"></script>
<script src="https://rtcmulticonnection.herokuapp.com/socket.io/socket.io.js"></script>
<script type="module">
var blocker = document.getElementById( 'blocker' );
var instructions = document.getElementById( 'instructions' );
var inputform = document.getElementById('inputform');


var connection = new RTCMultiConnection();
connection.socketURL = 'https://rtcmulticonnection.herokuapp.com:443/';
connection.session = {
    audio: true,
    video: true
};

connection.sdpConstraints.mandatory = {
    OfferToReceiveAudio: true,
    OfferToReceiveVideo: true
};

let teletubbies = ["teletubby/rosa.png", "teletubby/blu.png", "teletubby/verde.png", "teletubby/giallo.png"]
connection.onstream = function(event) {
    let container =document.getElementById('container');
	let img = document.createElement("img");


	img.src = teletubbies[Math.floor(Math.random() * teletubbies.length)];

	if(img.src.includes("rosa.png")){
		event.mediaElement.classList.add("rosa");
		// mutebutton.style.backgroundColor = "red";
	} else if (img.src.includes("blu.png")){
		event.mediaElement.classList.add("blue");
		// mutebutton.style.backgroundColor = "blue"
	} else if (img.src.includes("verde.png")){
		event.mediaElement.classList.add("green");
		// mutebutton.style.backgroundColor = "green"
	} else {
		event.mediaElement.classList.add("yellow");
		// mutebutton.style.backgroundColor = "yellow"
	}
	event.mediaElement.classList.add("video");

	img.classList.add("teletubby");

	let videoelement = document.createElement("div");
	videoelement.classList.add("videoelement");
	videoelement.appendChild( event.mediaElement );

	videoelement.appendChild(img);
	container.appendChild(videoelement)



};






connection.onstreamended = function(event) {
  var mediaElement = document.getElementById(event.streamid);
  if (mediaElement) {
	 console.log(mediaElement.parentNode);
	mediaElement.parentNode.parentNode.removeChild(mediaElement.parentNode);
  }
};



document.getElementById('btn-open-room').onclick = function() {
    // this.disabled = true;
	var predefinedRoomId = document.getElementById('room-id').value;
	instructions.style.display = 'none';
	blocker.style.display = 'none';
    connection.open( predefinedRoomId, function(
	  isRoomOpened,
	  roomid,
	  error
	) {
		if (error === "Room not available") {
		  let otherRoomId = prompt(
			"it looks like this room already exist - click okay to join the room where your virtual stoners already are", roomid
		  );
		  connection.join( otherRoomId, function(
	  	  isRoomOpened,
	  	  roomid,
	  	  error
	  	) {

	  		  return;


	  	  }
	  	);
		  return;
		}

	  }
	);
};
document.getElementById('btn-join-room').onclick = function() {

	var predefinedRoomId = document.getElementById('room-id').value;
    // this.disabled = true;
	instructions.style.display = 'none';
	blocker.style.display = 'none';
    connection.join( predefinedRoomId, function(
	  isRoomOpened,
	  roomid,
	  error
	) {
		if (error === "Room not available") {
		  let otherRoomId = prompt(
			"it looks like this room doesnt exist yet and u r alone - click okay to open a new room for your friends", roomid
		  );
		  connection.open( otherRoomId, function(
	  	  isRoomOpened,
	  	  roomid,
	  	  error
	  	) {

	  		  return;


	  	  }
	  	);
		  return;
		}

	  }
	);
};


document.getElementById("coverpic").addEventListener( 'click', function () {
    document.getElementById("coverpic").style.display = 'none';
	inputform.style.display ="inline-block";

});
document.getElementById("joint").addEventListener('click', function (target) {
	if(target.srcElement.children[0]){
		if(target.srcElement.children[0].children[0].id.length>2){
			let currentStream = document.getElementById(target.srcElement.children[0].children[0].id)
			if(currentStream.muted === false){
				currentStream.muted =true;
				currentStream.volume = 0;

			} else{
				currentStream.muted = false;
				currentStream.volume = 1;

			}
		}
	}




});
let chatbox = document.getElementById("chat");

document.getElementById("chattoggle").onclick = function(){

	if(chatbox.classList.contains("invisible")){
		chatbox.classList.add("visible");
		chatbox.classList.remove("invisible");
	} else{
		chatbox.classList.remove("visible");
		chatbox.classList.add("invisible");
	}

}




$(function () {
    var socket = io();
    $('form').submit(function(e) {
      e.preventDefault(); // prevents page reloading
      socket.emit('chatmessage', $('#m').val());
      $('#m').val('');
      return false;
    });
    socket.on('chatmessage', function(msg){
      $('#messages').append($('<li>').text(msg));
    });
    socket.on("livestream", function(stream){
        console.log("stream recieved frontend");
        var video2 = document.getElementById("video2");
        video2.srcObject = stream;

    })
  });

	ticker("ticker");


	function ticker(element) {


	  var ticker = document.getElementById(element);
	  var headlines = ticker.querySelector(".credits");
	  var links = headlines.getElementsByTagName("a");
	  var left = headlines.offsetLeft;
	  var animId;

	  moveHeadLines();

	  function moveHeadLines() {
		left--;
		if (left <= -links[0].offsetWidth) {
		  left += links[0].offsetWidth;
		  headlines.appendChild(links[0]);
		}
		headlines.style.left = left + "px";
		animId = requestAnimationFrame(moveHeadLines);
	  }
	}









		</script>
	</body>
</html>
